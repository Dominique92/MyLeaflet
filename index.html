<?=xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="fr" xml:lang="fr">
	<head>
		<title>Leaflet</title>
		<link type="image/x-icon" rel="shortcut icon" href="src/images/favicon.png" />
		<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
		<meta http-equiv="Content-Style-Type" content="text/css" />
		<meta http-equiv="Content-Script-Type" content="text/javascript" />

		<script type="text/javascript">
			var key = {
// Clé IGN V3 développement sur: http://api.ign.fr
// Clé IGN V3 production sur: http://pro.ign.fr/api-web => Service en ligne => S'ABONNER
				ign:  's62bgfv96pecuhmhux3fhcb2', // 15/07/2015
//				ign:  'y07s87qyij0i6yhj8nzi66ww', // chemineur.fr / Contrat n° 0005820 / Expire le 17/09/2016
//				ign:  'ev2w14tv2ez4wpypux2ael39', // www.refuges.info / Contract 0004365 / Expire le 31/08/2016
//				ign:  'w7b9fddebwo1jrxq8gpf8rtc', // dom.refuges.info / Contrat n° 0078363 / Expire le 28/10/2017
//				ign:  '7dy2so5o4sck2odtunq10ths', // sly.refuges.info / Contrat n° 0085217 / Expire le 05/01/2018
//				bing: 'AqTGBsziZHIJYYxgivLBf0hVdrAk9mWO5cQcb8Yux8sW5M8c8opEC2lZqKR1ZZXf', // https://www.bingmapsportal.com
				bing: 'ArLngay7TxiroomF7HLEXCS7kTWexf1_1s1qiF7nbTYs2IkD3XLcUnvSlKbGRZxt', // https://www.bingmapsportal.com
				os: 'CBE047F823B5E83CE0405F0ACA6042AB', // http://www.ordnancesurvey.co.uk/business-and-government/products/os-openspace/
			};
		</script>
		<link type="text/css" rel="stylesheet"  href="src/leaflet.css" />

		<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>
		<script type="text/javascript" src="src/leaflet.js"></script>
		<script type="text/javascript" src="src/CrossMarker.js"></script>

		<script type="text/javascript">
			var map, gps,
				blName = L.UrlUtil.queryParse(L.UrlUtil.hash()).layer, // Donné par le permalink #layer=NOM
				poiWRI = new L.GeoJSON.Ajax(
						'http://www.refuges.info/api/bbox', {
//DCMM???							proxy: 'proxy.php?url=',
							argsGeoJSON: {
								type_points: 'all',
							},
							degroup: 12,
							bbox: true,
							url: function(target) {
								return 'http://www.refuges.info/point/' + target.feature.properties.id;
							},
							icon: function(feature) {
								return {
									url: 'http://www.refuges.info/images/icones/' + feature.properties.type.icone + '.png'
								}
							}
						}
					),
				poiWRIfull = new L.GeoJSON.Ajax(
						'http://www.refuges.info/api/bbox', {
//DCMM???							proxy: 'proxy.php?url=',
							argsGeoJSON: {
								type_points: 'all',
								nb_points: 2000 // Test aux limites
							},
							degroup: 12,
							bbox: true,
							url: function(target) {
								return 'http://www.refuges.info/point/' + target.feature.properties.id;
							},
							icon: function(feature) {
								return {
									url: 'http://www.refuges.info/images/icones/' + feature.properties.type.icone + '.png'
								}
							}
						}
					),
 				hill = new L.TileLayer.OSM.hill(),
/*
				poiPRC = new L.GeoJSON.Ajax(
						'http://v2.chemineur.fr/prod/chem/json.php', {
							proxy: 'proxy.php?url=',
							argsGeoJSON: {
								site: 'prc',
							},
							degroup: 12,
							bbox: true,
							url: function(target) {
								return 'http://www.pyrenees-refuges.com/fr/affiche.php?numenr=' + target.feature.properties.id;
							},
							icon: function(feature) {
								return {
									url: 'http://v2.chemineur.fr/prod/chemtype/' + feature.properties.type.icone + '.png'
								}
							}
						}
					),
				poiC2C = new L.GeoJSON.Ajax(
						'http://v2.chemineur.fr/prod/chem/json.php', {
							proxy: 'proxy.php?url=',
							argsGeoJSON: {
								site: 'c2c',
							},
							degroup: 12,
							bbox: true,
							url: function(target) {
								return 'http://www.camptocamp.org/huts/' + target.feature.properties.id;
							},
							icon: function(feature) {
								return {
									url: 'http://v2.chemineur.fr/prod/chemtype/' + feature.properties.type.icone + '.png'
								}
							}
						}
					),
				poiCHEM = new L.GeoJSON.Ajax(
						'http://v2.chemineur.fr/prod/chem/json.php', {
							proxy: 'proxy.php?url=',
							degroup: 12,
							bbox: true,
							url: function(target) {
								return 'http://v2.chemineur.fr/point/' + target.feature.properties.id;
							},
							icon: function(feature) {
								return {
									url: 'http://v2.chemineur.fr/prod/chemtype/' + feature.properties.type.icone + '.png'
								}
							}
						}
					),
*/
				massif = new L.GeoJSON.Ajax(
						'http://www.refuges.info/api/polygones', {
//DCMM???							proxy: 'proxy.php?url=',
							argsGeoJSON: {
								massif: 351 // Pyrénées
/*
type_geom: 'polylines', massif: 2789 // Avec bug
								massif: 4 // Vercors
								massif: 3116 // multiple
*/
							},
							style: function(feature) {
								return {
									color: 'blue',
									weight: 2,
									opacity: 1,
									fillOpacity: 0
								}
							}
						}
					),
				massifs = new L.GeoJSON.Ajax(
						'http://www.refuges.info/api/polygones', {
//DCMM???							proxy: 'proxy.php?url=',
							argsGeoJSON: {
								type_polygon: 1
							},
							url: function(feature) {
								return feature.properties.lien;
							},
							style: function(feature) {
								return {
									color: feature.properties.couleur,
									weight: 2,
									opacity: 0.5
								}
							}
						}
					),
				cadre = new L.Marker.Position(
						new L.LatLng(47.49178789456123, 7.5), {
							projectionType: 'decimal',
							prefixe: 'cadre-',
							icon: L.icon({
								iconUrl: 'src/images/cadre.png',
								iconSize: [31, 43],
								iconAnchor: [15, 21]
							}),
						}
					),
				curseur = new L.Marker.Position(
//						new L.LatLng(46.45, 0.45), {
						new L.LatLng(46.5, 7.5), {
							prefixe: 'curseur-',
							draggable: true,
							riseOnHover: true, // The marker will get on top of others when you hover the mouse over it.
							icon: L.icon({
								iconUrl: 'src/images/curseur.png',
								iconSize: [30, 30],
								iconAnchor: [15, 15]
							}),
						}
					),
				crossmarker = new L.CrossMarker( // Un curseur dessiné
						new L.LatLng(45,5), {
							radius: 15,
							color: 'red',
							weight: 2,
							opacity: 1,
							fillOpacity: 0
						}
					),
				layers = [
					L.Map.maps('OSM-FR'),
//					L.Map.maps('OS-GB'), // DCMM BUG: On ne peut commencer que sur une carte EPSG3857
					massifs,
					poiWRI,
					massif,
					cadre,
					curseur,
					crossmarker
				];

			window.addEventListener('load', function() {
				map = new L.Map('map', {
					fullscreenControl: true,
//crs: layers[0].options.crs ? layers[0].options.crs : L.CRS.EPSG3857, DCMM TODO: On ne peut commencer que sur une carte EPSG3857
//crs: L.OSOpenSpace.getCRS(),
/*
					center: new L.LatLng(45.73845, 7.3161), // Aoste
					center: new L.LatLng(40.4, -3.7), // Madrid
					center: new L.LatLng(1.5, 101.5), // Exemple Singapour
					center: new L.LatLng(47.8517, 8.858), // poly 3116
					center: new L.LatLng(45.34, 5.872), // Bug cabane de Bellefond
					center: new L.LatLng(48.8, 2.2), // Chaville
					center: new L.LatLng(48.8533, 2.349), // Paris
					center: new L.LatLng(45.2, 5.7), // Grenoble
					center: new L.LatLng(51.5, 0), // London
					center: new L.LatLng(46.5, 7.5), // Swiss
					zoom: 18, // poly 3116
*/
					layers: layers,
				});
				if(0)				
					map.fitBounds([
					  [44, 1], // South West
					  [46, 6] // North East
					]);
				else
					map.setView([47, 2], 6); // Centre France

				// Le controle de changement de couche de carte avec la liste des cartes dispo
				new L.Control.Layers(L.Map.maps(), {WRI: poiWRIfull, Hill: hill}).addTo(map);

				var permalink = new L.Control.Permalink({text: 'Permalink', layers: L.Map.maps()}).addTo(map);
//permalink._params.target = 'IGN';
				permalink.on('update', function(e) {
//alert('IGN');
//permalink._params.target = 'IGN';
				});

				gps = new L.Control.Gps().addTo(map);
				gps.on ('gpslocated', function (e){
					map.setView(e.latlng,16,{reset:true});
					curseur.setLatLng(e.latlng); // Déplacement du curseur à la position GPS
				});
				new L.Control.Scale().addTo(map);
				new L.Control.Coordinates().addTo(map);
				new L.Control.OSMGeocoder().addTo(map);

				var poly =
					new L.Polyline(
						[[43.5, -1.5], [43.56, -1.2], [43.55, -0.96], [43.3, -0.36]],
						{}
					)
					.addTo(map);
				var poly2 =
					new L.Polyline(
						[[44.5, -1.5], [44.56, -1.2], [44.55, -0.96], [44.3, -0.36]]
					)
					.addTo(map);

				// Editeur
				var edit = new L.Control.PolylineEditor({
					idInput: 'input',
					idChange: 'changed',
					submit: '<non implémenté>',
				})
				.addTo(map);

				// Chargement fichier GPX
				var fl = L.Control.fileLayerLoad();
				fl.addTo(map);
				fl.loader.on ('data:loaded', function (args){
					edit.addEdit(args.layer);
				}, fl);
			});
		</script>
	</head>

	<body>

<div style="float:right">
<span id="changed" style="display:none"><i>Changed</i></span>
<textarea id="input" rows="40" cols="50">
[[[5.72,45.178],[5.6,45.32],[5.2,45.08],[5.03,44.8],[5.24,44.82],[5.29,44.83],[5.4,44.8],[5.44,44.74],[5.48,44.69],[5.61,44.76],[5.62437,44.7841],[5.59,44.87],[5.63,44.9],[5.64,45.02],[5.72,45.09],[5.72,45.18]]]
</textarea></div>

<!--
this.elInput.parentNode.firstChild.textContent=this.options.msgChange;

<div style="float:right">
<textarea id="input" rows="40" cols="50">
[[[[5.72,45.179999999999978],[5.6,45.319999999999993],[5.2,45.079999999999991],[5.03,44.800000000000004],[5.24,44.82],[5.29,44.830000000000005],[5.4,44.800000000000004],[5.44,44.740000000000009],[5.48,44.689999999999991],[5.61,44.759999999999984],[5.624377485413712,44.784103986156602],[5.590000000000001,44.869999999999997],[5.63,44.909999999999997],[5.64,45.019999999999996],[5.72,45.089999999999982],[5.72,45.179999999999978]]]]
</textarea></div>

<div style="float:right">
<textarea id="input" rows="40" cols="50"></textarea>
</div>

<div id="input" style="float:right"></div>

<div style="float:right">
<textarea id="input" rows="40" cols="50">
{ "type": "MultiPolygon",
	"coordinates": [
	  [[[102.0, 2.0], [103.0, 2.0], [103.0, 3.0], [102.0, 3.0], [102.0, 2.0]]],
	  [[[100.0, 0.0], [101.0, 0.0], [101.0, 1.0], [100.0, 1.0], [100.0, 0.0]],
	   [[100.2, 0.2], [100.8, 0.2], [100.8, 0.8], [100.2, 0.8], [100.2, 0.2]]]
	  ]
	}
</textarea>
</div>

<div style="float:right">
<textarea id="input" rows="40" cols="50">
{"type":"MultiPolygon","coordinates":[[[[8.857576099999999,47.851680899999998],[8.857609200000001,47.851767299999999],[8.857664400000001,47.851811699999999],[8.857701199999999,47.851841200000003],[8.857778400000001,47.851880800000004],[8.857866700000001,47.851888199999998],[8.8579881,47.851873400000002],[8.858091099999999,47.851831400000002],[8.858208899999999,47.851801700000003],[8.858242799999999,47.851795600000003],[8.858345,47.8517771],[8.8584479,47.851747500000002],[8.858503199999999,47.851708000000002],[8.8585657,47.8516932],[8.858635599999999,47.851685799999998],[8.8587202,47.8516488],[8.8588159,47.851594400000003],[8.858863700000001,47.8514932],[8.8588453,47.851379700000003],[8.858723899999999,47.851293300000002],[8.858643000000001,47.851224100000003],[8.8585657,47.851140200000003],[8.8584701,47.851095800000003],[8.8583192,47.851043900000001],[8.8581904,47.850984699999998],[8.858142600000001,47.850918],[8.858127899999999,47.850856200000003],[8.8580469,47.850829099999999],[8.857973400000001,47.850843900000001],[8.8579145,47.850893300000003],[8.857859400000001,47.850974800000003],[8.8578005,47.851088300000001],[8.857749,47.851177200000002],[8.857653300000001,47.851310400000003],[8.8576386,47.8514439],[8.8576242,47.851514100000003],[8.857612899999999,47.8515698],[8.857576099999999,47.851680899999998]]],[[[8.856821,47.852139299999997],[8.8568444,47.852233599999998],[8.8568886,47.852298099999999],[8.8569432,47.852353999999998],[8.8570291,47.852411600000003],[8.857112300000001,47.852460499999999],[8.8572112,47.852514599999999],[8.8573048,47.852563500000002],[8.8574167,47.852596699999999],[8.8575494,47.852584399999998],[8.8576508,47.852545900000003],[8.857723699999999,47.852488399999999],[8.8577523,47.852434299999999],[8.8577549,47.852380199999999],[8.857749699999999,47.852312099999999],[8.857721,47.852245799999999],[8.8576716,47.8522021],[8.857656,47.8521742],[8.8576482,47.852099000000003],[8.8576716,47.852034600000003],[8.857687200000001,47.851987399999999],[8.857687200000001,47.851947299999999],[8.857658600000001,47.851898400000003],[8.8575936,47.8518373],[8.857518199999999,47.851818100000003],[8.8573933,47.851830300000003],[8.857268400000001,47.851856400000003],[8.857146200000001,47.851914100000002],[8.857016,47.851975199999998],[8.856925,47.852018800000003],[8.856857400000001,47.852072999999997],[8.856821,47.852139299999997]]]]}
</textarea>
</div>

<input id="input" type="text" name="geom" size="60" value='{"type":"MultiPolygon","coordinates":[[[[8.857576099999999,47.851680899999998],[8.857609200000001,47.851767299999999],[8.857664400000001,47.851811699999999],[8.857701199999999,47.851841200000003],[8.857778400000001,47.851880800000004],[8.857866700000001,47.851888199999998],[8.8579881,47.851873400000002],[8.858091099999999,47.851831400000002],[8.858208899999999,47.851801700000003],[8.858242799999999,47.851795600000003],[8.858345,47.8517771],[8.8584479,47.851747500000002],[8.858503199999999,47.851708000000002],[8.8585657,47.8516932],[8.858635599999999,47.851685799999998],[8.8587202,47.8516488],[8.8588159,47.851594400000003],[8.858863700000001,47.8514932],[8.8588453,47.851379700000003],[8.858723899999999,47.851293300000002],[8.858643000000001,47.851224100000003],[8.8585657,47.851140200000003],[8.8584701,47.851095800000003],[8.8583192,47.851043900000001],[8.8581904,47.850984699999998],[8.858142600000001,47.850918],[8.858127899999999,47.850856200000003],[8.8580469,47.850829099999999],[8.857973400000001,47.850843900000001],[8.8579145,47.850893300000003],[8.857859400000001,47.850974800000003],[8.8578005,47.851088300000001],[8.857749,47.851177200000002],[8.857653300000001,47.851310400000003],[8.8576386,47.8514439],[8.8576242,47.851514100000003],[8.857612899999999,47.8515698],[8.857576099999999,47.851680899999998]]],[[[8.856821,47.852139299999997],[8.8568444,47.852233599999998],[8.8568886,47.852298099999999],[8.8569432,47.852353999999998],[8.8570291,47.852411600000003],[8.857112300000001,47.852460499999999],[8.8572112,47.852514599999999],[8.8573048,47.852563500000002],[8.8574167,47.852596699999999],[8.8575494,47.852584399999998],[8.8576508,47.852545900000003],[8.857723699999999,47.852488399999999],[8.8577523,47.852434299999999],[8.8577549,47.852380199999999],[8.857749699999999,47.852312099999999],[8.857721,47.852245799999999],[8.8576716,47.8522021],[8.857656,47.8521742],[8.8576482,47.852099000000003],[8.8576716,47.852034600000003],[8.857687200000001,47.851987399999999],[8.857687200000001,47.851947299999999],[8.857658600000001,47.851898400000003],[8.8575936,47.8518373],[8.857518199999999,47.851818100000003],[8.8573933,47.851830300000003],[8.857268400000001,47.851856400000003],[8.857146200000001,47.851914100000002],[8.857016,47.851975199999998],[8.856925,47.852018800000003],[8.856857400000001,47.852072999999997],[8.856821,47.852139299999997]]]]}' />

<div id="input" style="float:right"><textarea rows="40" cols="50">[[[[11.0209156,45.949950800000003],[11.021610000000001,45.950083900000003],[11.022133500000001,45.949820600000002],[11.022003,45.9497122],[11.0218758,45.949553399999999],[11.0215414,45.949423799999998],[11.0210358,45.9495997],[11.0209156,45.949950800000003]],[[11.021114600000001,45.9499],[11.0211319,45.949719299999998],[11.0212697,45.949629999999999],[11.0214815,45.949612700000003],[11.021744399999999,45.949627800000002],[11.0219197,45.949749400000002],[11.0218492,45.949883399999997],[11.021470600000001,45.950026999999999],[11.021114600000001,45.9499]]]]</textarea></div>

<input type="text" name="geom" size="60" value="[[5.72,45.179999999999978],[5.72,45.089999999999989],[5.64,45.019999999999996],[5.63,44.909999999999989],[5.590000000000001,44.869999999999997],[5.650000000000001,44.719999999999985],[5.61,44.759999999999998],[5.48,44.689999999999991],[5.44,44.740000000000002],[5.4,44.800000000000004],[5.29,44.830000000000013],[5.24,44.82],[5.35983703614958,45.090948123959961],[5.6,45.319999999999972],[5.72,45.179999999999978]]" />

-->
<script>
function switch_massif (combo) {
	if (combo.checked) {
		map.addLayer(massif);
//		map.removeLayer(poiBbox);
//		map.addLayer(poiLayer = poiMassif);
	} else {
		map.removeLayer(massif);
//		map.removeLayer(poiMassif);
//		map.addLayer(poiLayer = poiBbox);
	}
}
function couche_externe(e,l) {
	if(e.checked)
		map.addLayer(l);
	else
		map.removeLayer(l);
}
</script>

		<div id="map" style="width: 50%"></div>

		<form method="post" enctype="multipart/form-data" action="#">
			<span id="curseur-titre-lng"></span>: <input type="hidden" id="curseur-lng" name="longitude" /><input id="curseur-proj-lng" type="text" size="10" />
			<span id="curseur-titre-lat"></span>: <input type="hidden" id="curseur-lat" name="latitude"  /><input id="curseur-proj-lat" type="text" size="10" />
			<select id="curseur-select-projection"><option></option></select>
		</form>
			<span id="cadre-titre-lng"></span>: <span id="cadre-aff-lng"></span>
			<span id="cadre-titre-lat"></span>: <span id="cadre-aff-lat"></span>
			<select id="cadre-select-projection">Degrés décimaux</select>
		</p>
		<p>
			<a href="github.com/Dominique92/Leaflet.MapMultiCRS">Démo cartes multifournisseurs</a>
		</p>
		<p>
			<a href="github.com/Dominique92/Leaflet.GeoJSON.Ajax">Démo couches GeoJSON AJAX</a>
		</p>
		<p>
			<a onclick="curseur.setLatLng(map.getCenter())" style="cursor:pointer;color:#02F">Centrer le viseur sur la carte</a>
		</p>
		<p>
			<a onclick="gps.activate()" style="cursor:pointer;color:#02F">Centrer le viseur sur votre position GPS</a>
		</p>
		<p>
			<a onclick="poiWRI.reload({liste_id_massif:4})" style="cursor:pointer;color:#02F">Reduire scope au massif du Vercors</a>
		</p>
		<p>
			<a href="github.com/Dominique92/Leaflet.MapMultiCRS/swiss.html">Test SwissTopo</a>
		</p>
		<p>
			TEST: switch_massif WRI
			<input name="id_massif" type="checkbox" checked="checked" value="4"onclick="switch_massif(this)"/>
		</p>
		<p>
			TEST: Swap 2000 pictos WRI
			<input
				id="poiWRIfull"
				onclick="couche_externe(this, poiWRIfull)"
				type="checkbox"
			/>
		</p>
		<p>
			<a href="build">Générer les librairies compressées leaflet.css &amp; leaflet.js</a>
		</p>
		<p>
			<a href="build/test-versions.php">Vérifier les versions des pluggins importés</a>
		</p>
	</body>
</html>
