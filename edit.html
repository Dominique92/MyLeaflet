<!DOCTYPE html>
<html>
<head>
	<title>Leaflet.draw vector editing handlers</title>
		<link type="text/css" rel="stylesheet"  href="src/leaflet.css" />
		<script type="text/javascript" src="src/leaflet.js"></script>
</head>
<body>
	<div id="carte" style="width: 800px; height: 600px"></div>
	<div id="change" style="display:none"><i>Changé</i></div>
	<textarea id="entree" rows="20" cols="120">
{"type":"FeatureCollection","features":[{"type":"Feature","properties":{},"geometry":{"type":"LineString","coordinates":[[2.581787109375,46.22545288226939],[2.713623046875,45.1510532655634],[4.185791015625,44.972570682240644],[4.866943359375,45.805828539928356]]}},{"type":"Feature","properties":{},"geometry":{"type":"Point","coordinates":[3.1640625,45.336701909968106]}}]}
	</textarea>

	<script>
window.addEventListener('load', function() {
	var carte = L.map('carte').setView([45, 5], 7);
	new L.TileLayer.OSM.FR().addTo(carte);

	var accrochables = L.featureGroup().addTo(carte); // Couches auxquelles le snap s'accroche
	var editables = L.featureGroup().addTo(accrochables); // Couches éditables
	var optionsEdit = {
		featureGroup: editables,
		edit: false, // Permet le contrôle delete
		marker: {guideLayers: [accrochables]},
		polyline: {guideLayers: [accrochables]},
		polygon: {guideLayers: [accrochables]},
		rectangle: false,
		circle: false
	};
	var editeur = new L.Control.Draw({
		edit: optionsEdit, // Snap à la création d'élements
		draw: optionsEdit, // Snap à l'édition d'élements
	}).addTo(carte);

	// Ajout d'un nouveau feature éditable
	carte.on('draw:created', function(e) {
		e.layer.addTo(editables);
		if (e.layer._latlng) // Point
			e.layer.snapediting = new L.Handler.MarkerSnap(carte, e.layer);
		else // Ligne
			e.layer.snapediting = new L.Handler.PolylineSnap(carte, e.layer);
		e.layer.options.editing = {}; //DCMM TODO voir pourquoi (nouvelle version de draw)
		e.layer.snapediting.addGuideLayer(accrochables);
		e.layer.snapediting.enable();
	});

	// Initialisation des couches éditables avec le contenu du champ en entrée
	var ljs = new L.geoJson(JSON.parse(document.getElementById('entree').innerHTML));
	for (var l in ljs._layers)
		carte.fire('draw:created', {
			layer: ljs._layers[l]
		});
/*
						carte.on('draw:editstart', function (e) {
							for (var l in editables._layers)
								editables._layers[l].snapediting.enable();
						});
						carte.on('draw:editstop', function (e) {
						});
*/

	// Restitution des couches éditables dans le champ en sortie
	L.DomEvent.on(document, 'mouseup', edited);
	carte.on('draw:drawstop', edited);
	carte.on('draw:edited', edited);
	carte.on('draw:deleted', edited);
	function edited() {
		document.getElementById('entree').innerHTML = JSON.stringify(editables.toGeoJSON());
		document.getElementById('change').style.display = '';

		// Fusionne les segments ayant mêmes extrémités
		var change = true;
		while (change) {
			change = false;
			for (il1 in editables._layers) // Pour toutes les couches
				for (il2 in editables._layers) {
					var el1 = editables._layers[il1],
						el2 = editables._layers[il2],
						ll1 = el1._latlngs,
						ll2 = el2._latlngs,
						lladd = null; // Les points à ajouter
					if (ll1 && !el1.options.fill &&  // Si les 2 sont des Polyline
						ll2 && !el2.options.fill &&
						el1._leaflet_id < el2._leaflet_id) { // 1 seule fois chaque couple
						if (ll1[0].equals(ll2[0])) {
							ll1.reverse();
							lladd = ll2;
						} else if (ll1[0].equals(ll2[ll2.length - 1])) {
							ll1.reverse();
							lladd = ll2.reverse();
						} else if (ll1[ll1.length - 1].equals(ll2[0])) {
							lladd = ll2;
						} else if (ll1[ll1.length - 1].equals(ll2[ll2.length - 1])) {
							lladd = ll2.reverse();
						}
						if (lladd) { // Points à fusionner
							ll1.pop(); // On enlève le dernier point pour qu'il ne soit pas en double
							el1._latlngs = ll1.concat(lladd);
							el1.editing._poly.redraw(); // On redessine le trait
							el1.snapediting.updateMarkers(); // On redessine les marqueurs
							editables.removeLayer(el2.editing._poly); // On efface l'autre polyline
							change = true;
						}
					}
				}
		}
	}

	new L.GeoJSON.Ajax(
		'http://www.refuges.info/api/bbox', {
			argsGeoJSON: {
				type_points: 'all',
				nb_points: 10,
			},
			degroup: 12,
			bbox: true,
			url: function(target) {
				return 'http://www.refuges.info/point/' + target.feature.properties.id;
			},
			icon: function(feature) {
				return {
					url: 'http://www.refuges.info/images/icones/' + feature.properties.type.icone + '.png'
				}
			},
		}
	).addTo(accrochables);
	new L.GeoJSON.Ajax(
		'http://www.refuges.info/api/polygones', {
			argsGeoJSON: {
				massif: 4 // Vercors
			},
			style: function(feature) {
				return {
					color: 'blue',
					weight: 2,
					opacity: 1,
					fillOpacity: 0,
				}
			}
		}
	).addTo(accrochables);
});
	</script>
</body>
</html>
